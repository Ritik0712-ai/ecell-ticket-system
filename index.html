<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Cell Ticket System</title>
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (via CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .hidden { display: none !important; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>

    <!-- NAV BAR -->
    <header class="border-b border-slate-800 bg-slate-900/80 sticky top-0 z-50 backdrop-blur">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-emerald-600 rounded flex items-center justify-center">
                    <i data-lucide="ticket" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-lg text-white">E-Cell<span class="text-emerald-500">Ticketing</span></h1>
            </div>
            <div class="flex bg-slate-800 p-1 rounded-lg">
                <button id="btn-dashboard" class="px-4 py-1.5 rounded-md text-sm font-medium bg-slate-700 text-white transition-all">Organizer</button>
                <button id="btn-verifier" class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all">Verifier</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-6">
        <div id="loading-screen" class="min-h-[50vh] flex items-center justify-center text-emerald-400">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mr-2"></i> Connecting to Database...
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="grid lg:grid-cols-12 gap-6 hidden">
            <!-- Left Col -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Analytics -->
                <div class="glass rounded-xl p-5 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="bar-chart-3" class="w-24 h-24 text-emerald-500"></i></div>
                    <h3 class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-4">Analytics</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><div id="stat-total" class="text-3xl font-bold text-white">0</div><div class="text-xs text-slate-500">Issued</div></div>
                        <div><div id="stat-used" class="text-3xl font-bold text-emerald-400">0</div><div class="text-xs text-slate-500">Checked In</div></div>
                    </div>
                </div>

                <!-- Form -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                    <h3 class="text-white font-semibold mb-4 flex items-center gap-2"><i data-lucide="scan" class="w-4 h-4 text-emerald-500"></i> Issue Ticket</h3>
                    <form id="create-form" class="space-y-4">
                        <input type="text" id="inp-name" required class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white" placeholder="Participant Name">
                        <input type="email" id="inp-email" required class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white" placeholder="Email Address">
                        <select id="inp-type" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                            <option>Standard</option><option>VIP</option><option>Speaker</option>
                        </select>
                        <button type="submit" id="btn-submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-2 rounded-lg flex items-center justify-center gap-2">
                            Generate Ticket
                        </button>
                    </form>
                </div>
            </div>

            <!-- Middle Col: List -->
            <div class="lg:col-span-5 bg-slate-900 border border-slate-800 rounded-xl overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-slate-800"><h3 class="font-semibold text-slate-200">Records</h3></div>
                <div id="ticket-list" class="overflow-y-auto flex-1 p-2 space-y-2">
                    <!-- Tickets injected here via JS -->
                </div>
            </div>

            <!-- Right Col: Preview -->
            <div class="lg:col-span-3">
                <div id="ticket-preview" class="hidden bg-white text-slate-900 rounded-xl p-6 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-500 to-indigo-600"></div>
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold">EVENT PASS</h2></div>
                    <div class="flex justify-center mb-6" id="qr-container">
                        <!-- QR Image here -->
                    </div>
                    <div class="space-y-3 mb-6">
                        <div class="border-b pb-2"><p class="text-xs text-slate-400 uppercase">Attendee</p><p id="prev-name" class="font-bold">--</p></div>
                        <div class="border-b pb-2"><p class="text-xs text-slate-400 uppercase">Type</p><p id="prev-type" class="font-bold">--</p></div>
                        <div class="border-b pb-2"><p class="text-xs text-slate-400 uppercase">ID</p><p id="prev-id" class="font-mono text-xs">--</p></div>
                    </div>
                    <button id="btn-email" class="w-full bg-slate-900 text-white py-2 rounded-lg text-xs font-medium flex items-center justify-center gap-1">
                        <i data-lucide="mail" class="w-3 h-3"></i> Email Ticket
                    </button>
                </div>
                <div id="ticket-placeholder" class="h-full bg-slate-900 border border-slate-800 rounded-xl flex items-center justify-center text-slate-600">
                    <p>Select a ticket</p>
                </div>
            </div>
        </div>

        <!-- VERIFIER VIEW -->
        <div id="view-verifier" class="hidden max-w-xl mx-auto mt-10">
            <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="shield-check" class="w-6 h-6 text-indigo-400"></i> Validator</h2>
                <textarea id="verify-input" placeholder='Paste JSON payload here...' class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 h-24 mb-4 font-mono"></textarea>
                <button id="btn-verify-action" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md w-full font-bold transition-colors">
                    VERIFY TICKET
                </button>
                
                <div id="verify-result" class="hidden mt-4 p-4 rounded-xl border-l-4">
                    <h3 id="res-title" class="font-bold text-lg"></h3>
                    <p id="res-msg" class="text-sm text-slate-300"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        // --- 1. IMPORT FIREBASE DIRECTLY FROM GOOGLE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- 2. PASTE YOUR FIREBASE CONFIG HERE ---
        // REPLACE THIS OBJECT WITH THE ONE FROM YOUR FIREBASE CONSOLE
       const firebaseConfig = {
    apiKey: "AIzaSyCHQodnoRk-Bsx3dXut1HcxPd2bQsx_vqs",
    authDomain: "ticket-system-d30e9.firebaseapp.com",
    projectId: "ticket-system-d30e9",
    storageBucket: "ticket-system-d30e9.firebasestorage.app",
    messagingSenderId: "41228288594",
    appId: "1:41228288594:web:d4286ffab35ed1089a558b",
    measurementId: "G-X30YB8RN5Q"
  };
        // --------------------------------------------------

        // Init App
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SECRET_SALT = "E-CELL-PRODUCTION-SECRET";
        let currentUser = null;
        let selectedTicketData = null;

        // --- AUTH ---
        signInAnonymously(auth).catch(console.error);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                initDataListener();
            }
        });

        // --- VIEW SWITCHING ---
        const btnDash = document.getElementById('btn-dashboard');
        const btnVer = document.getElementById('btn-verifier');
        const viewDash = document.getElementById('view-dashboard');
        const viewVer = document.getElementById('view-verifier');

        btnDash.addEventListener('click', () => {
            viewDash.classList.remove('hidden');
            viewVer.classList.add('hidden');
            btnDash.classList.add('bg-slate-700', 'text-white');
            btnDash.classList.remove('text-slate-400');
            btnVer.classList.remove('bg-indigo-600', 'text-white');
            btnVer.classList.add('text-slate-400');
        });

        btnVer.addEventListener('click', () => {
            viewVer.classList.remove('hidden');
            viewDash.classList.add('hidden');
            btnVer.classList.add('bg-indigo-600', 'text-white');
            btnVer.classList.remove('text-slate-400');
            btnDash.classList.remove('bg-slate-700', 'text-white');
            btnDash.classList.add('text-slate-400');
        });

        // --- DASHBOARD LOGIC ---
        function initDataListener() {
            const q = query(collection(db, 'tickets'));
            onSnapshot(q, (snapshot) => {
                const tickets = [];
                let usedCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tickets.push({ id: doc.id, ...data });
                    if(data.status === 'USED') usedCount++;
                });
                
                // Sort by time (newest first)
                tickets.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                // Update UI
                document.getElementById('stat-total').innerText = tickets.length;
                document.getElementById('stat-used').innerText = usedCount;
                renderList(tickets);
            });
        }

        function renderList(tickets) {
            const container = document.getElementById('ticket-list');
            container.innerHTML = '';
            tickets.forEach(t => {
                const el = document.createElement('div');
                el.className = `p-3 rounded-lg border cursor-pointer flex justify-between bg-slate-950 border-slate-800 hover:border-emerald-500/50 transition-colors`;
                el.innerHTML = `
                    <div>
                        <div class="font-medium text-slate-200">${t.name}</div>
                        <div class="text-xs text-slate-500">${t.email}</div>
                    </div>
                    <span class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold h-fit ${t.status === 'USED' ? 'bg-slate-800 text-slate-500' : 'bg-emerald-500/10 text-emerald-400'}">${t.status}</span>
                `;
                el.onclick = () => showPreview(t);
                container.appendChild(el);
            });
        }

        function showPreview(ticket) {
            selectedTicketData = ticket;
            document.getElementById('ticket-placeholder').classList.add('hidden');
            document.getElementById('ticket-preview').classList.remove('hidden');
            
            document.getElementById('prev-name').innerText = ticket.name;
            document.getElementById('prev-type').innerText = ticket.type;
            document.getElementById('prev-id').innerText = ticket.id;

            // Generate Payload & QR
            const signature = generateSignature({ id: ticket.id });
            const payload = JSON.stringify({ id: ticket.id, signature });
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(payload)}`;
            
            document.getElementById('qr-container').innerHTML = `
                <div class="bg-white p-2 rounded-lg inline-block border-2 border-slate-200">
                    <img src="${qrUrl}" alt="QR" width="150" height="150">
                </div>
            `;
        }

        // Generate Ticket Form
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = 'Generating...';
            btn.disabled = true;

            try {
                await addDoc(collection(db, 'tickets'), {
                    name: document.getElementById('inp-name').value,
                    email: document.getElementById('inp-email').value,
                    type: document.getElementById('inp-type').value,
                    status: 'ISSUED',
                    createdAt: serverTimestamp(),
                    issuedBy: currentUser.uid
                });
                
                // Reset form
                e.target.reset();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerText = 'Generate Ticket';
                btn.disabled = false;
            }
        });

        // Email Button
        document.getElementById('btn-email').addEventListener('click', () => {
            if(!selectedTicketData) return;
            const signature = generateSignature({ id: selectedTicketData.id });
            const payload = JSON.stringify({ id: selectedTicketData.id, signature });
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(payload)}`;
            
            const subject = encodeURIComponent(`Your Ticket: 2025 Global Summit`);
            const body = encodeURIComponent(`Hello ${selectedTicketData.name},\n\nHere is your ticket.\n\nLink to QR: ${qrUrl}`);
            window.location.href = `mailto:${selectedTicketData.email}?subject=${subject}&body=${body}`;
        });

        // --- VERIFIER LOGIC ---
        document.getElementById('btn-verify-action').addEventListener('click', async () => {
            const input = document.getElementById('verify-input').value;
            const resBox = document.getElementById('verify-result');
            const resTitle = document.getElementById('res-title');
            const resMsg = document.getElementById('res-msg');

            resBox.classList.add('hidden'); // Reset

            try {
                const payload = JSON.parse(input);
                const { id, signature } = payload;
                if(!id || !signature) throw new Error("Invalid Payload");

                // Check Signature
                if(signature !== generateSignature({id})) throw new Error("FAKE TICKET DETECTED");

                // Check DB
                const ref = doc(db, 'tickets', id);
                const snap = await getDoc(ref);
                if(!snap.exists()) throw new Error("Ticket not found in DB");
                
                const data = snap.data();
                if(data.status === 'USED') {
                    showResult('warning', 'ALREADY USED', `Scanned before. Owner: ${data.name}`);
                } else {
                    // Mark as used
                    await updateDoc(ref, { status: 'USED', usedAt: serverTimestamp(), verifiedBy: currentUser.uid });
                    showResult('success', 'ACCESS GRANTED', `Welcome, ${data.name} (${data.type})`);
                }

            } catch (err) {
                showResult('error', 'INVALID TICKET', err.message);
            }
        });

        function showResult(type, title, msg) {
            const box = document.getElementById('verify-result');
            const titleEl = document.getElementById('res-title');
            const msgEl = document.getElementById('res-msg');
            
            box.classList.remove('hidden', 'bg-emerald-900/20', 'border-emerald-500', 'text-emerald-400', 'bg-red-900/20', 'border-red-500', 'text-red-400', 'bg-amber-900/20', 'border-amber-500', 'text-amber-400');

            if(type === 'success') {
                box.classList.add('bg-emerald-900/20', 'border-emerald-500', 'text-emerald-400');
            } else if (type === 'error') {
                box.classList.add('bg-red-900/20', 'border-red-500', 'text-red-400');
            } else {
                box.classList.add('bg-amber-900/20', 'border-amber-500', 'text-amber-400');
            }

            titleEl.innerText = title;
            msgEl.innerText = msg;
        }

        // --- UTILS ---
        function generateSignature(data) {
            const str = JSON.stringify(data) + SECRET_SALT;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // Render Icons
        lucide.createIcons();
    </script>
</body>
</html>